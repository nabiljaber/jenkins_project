pipeline {
  agent any

  environment {
    VENV = 'venv'
  }

  stages {

    stage('Setup') {
      steps {
        script {
          // Create venv if missing
          if (!fileExists("${env.WORKSPACE}\\${VENV}\\Scripts\\activate.bat")) {
            bat 'py -3 -m venv venv || python -m venv venv'
          }
          // Install deps
          bat """
            call ${VENV}\\Scripts\\activate
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          """
        }
      }
    }

    stage('Lint') {
      steps {
        bat """
          call ${VENV}\\Scripts\\activate
          flake8 app.py
        """
      }
    }

    stage('Test') {
      steps {
        bat """
          call ${VENV}\\Scripts\\activate
          pytest --maxfail=1 --disable-warnings -q
        """
      }
    }

    stage('Coverage') {
      steps {
        bat """
          call ${VENV}\\Scripts\\activate
          python -m coverage run -m pytest
          python -m coverage report
          python -m coverage xml
        """
      }
    }

    stage('Security Scan') {
      steps {
        bat """
          call ${VENV}\\Scripts\\activate
          python -m bandit -r .
        """
      }
    }

    stage('Deploy') {
      steps {
        bat """
          call ${VENV}\\Scripts\\activate
          python app.py
        """
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
